# 이벤트

---



### 10.1 시스템 간 강결합 문제
여러 바운디드 컨텍스트간의 강결합으로 인해 로직이 섞이거나 트랜잭션 처리가 복잡해질 수 있음  
이를 비동기 이벤트를 통해 강결합을 없앰

### 10.2 이벤트 개요
책에서 말하는 이벤트 -> 과거에 벌어진 어떠한 일

#### 10.2.1 이벤트 관련 구성요소
- 이벤트, 이벤트 생성 주체, 이벤트 디스패처, 이벤트 핸들러를 구현해야 됨
- 도메인 모델에서의 이벤트 생성주체: 엔티티, 벨류, 도메인 서비스
- 이벤트 핸들러: 생성 주체가 발생한 이벤트에 반응
- 이벤트 디스패처: 생성주체와 핸들러를 연결하여 이벤트를 전달해줌

#### 10.2.2 이벤트의 구성
- 이벤트의 종류: 클래스 이름으로 이벤트 종류를 표현, 이벤트 발생 시간, 추가 데이터
- 이벤트 핸들러에서 처리에 필요한 데이터를 담아야 하며, 그에 해당하는 정보가 없을때는 정보를 추출해야 한다.
- 이벤트의 동작과 무관한 데이터는 담을 필요가 없다.

#### 10.2.3 이벤트 용도
- 이벤트의 용도 트리거 및 동기화

#### 10.2.4 이벤트의 장점 
- 서로 다른 도메인 로직이 섞이는 것을 방지할 수 있음

### 10.3 이벤트, 핸들러, 디스패처 구현

#### 10.3.1 이벤트 클래스
- 이벤트의 상위 타입이 존재하진 않지만 모든 이벤트의 공공으로 사용되는 이벤트가 있다면 상위 클래스를 만들어도 됨

#### 10.3.2 Events 클래스와 ApplicationEventPublisher
- 스프링에서 지원하는 ApplicationEventPublisher를 통해 이벤트를 전달 할 수 있음

#### 10.3.3 이벤트 발생과 이벤트 핸들러
- 스프링에서 제공하는 EventListener 애너테이션을 사용하여 이벤트 핸들러를 구현
- publishEvent() 메서드를 실행한 객체를 EventListener에서 설정했다면 그에 맞는 핸들러가 실행됨

### 10.4 동기 이벤트 처리 문제
외부 시스템 연동에서 문제가 생겼을 때 트랜잭션과 성능 저하 문제가 발생할 수 있음  
-> 비동기 이벤트 처리 또는 트렌잭션을 연계 하는 방법이 존재

### 10.5 비동기 이벤트 처리

#### 네 가지 비동기 이벤트 처리 방식
- 로컬 핸들러를 비동기로 실행하기
- 메시지 큐를 사용하기
- 이벤트 저장소와 이벤트 포워더 사용하기
- 이벤트 저장소와 이벤트 제공 API 사용하기

#### 10.5.1 로컬 핸들러 비동기 실행
- 이벤트 핸들러를 비동기로 실행하는 방법 -> 이벤트 핸들러를 별도 스레드로 실행
- 스프링에서 제공하는 @Async 애너테이션을 사용하면 비동기로 실행 가능
- @EnableAsync 애너테이션을 사용 및 이벤트 핸들러에 @Async 애너테이션을 붙임

#### 10.5.2 메시징 시스템을 이용한 비동기 구현
- 카프카나 래빗엠큐와 같은 메시징 시스템을 사용하여 비동기로 이벤트를 처리
- 필요하다면 메시지 큐에 이벤트를 저장하는 것까지 하나의 트랜잭션으로 묶어야할 수도 있음
- 글로벌 트랜잭션이 필요 -> 이로 인해 성능이 떨어짐
- 동일 jvm에서 메시징 시스템을 이용해서 비동기 이벤트를 처리하는 것은 시스템을 복잡하게만 만들 뿐임

#### 10.5.3 이벤트 저장소를 이용한 비동기 처리
- 이벤트 저장소(DB)를 이용하여 주기적으로 데이터를 읽어서 처리 또는 API를 활용

### 10.6 이벤트 적용 시 추가 고려 사항
- 이벤트 소스를 EventEntry에 추가할지에 대한 여부
  -> 특정 주체가 발생시킨 이벤트만 조회하는 기능을 구현할 수 없기 때문에 필요하다면 주체 정보를 추가해야 함
- 포워더에서의 전송 실패를 얼마나 허용할 것인지에 대한 정의
- 이벤트 손실에 대한 처리
- 이벤트가 순서대로 외부 시스템에 전달해야할 경우 이벤트 스토어를 이용하는 게 좋음  
  메시징 시스템은 사용 기술에 따라 이벤트 발생 순서와 전달 순서가 달라질 수 있음
- 동일한 이벤트에 대한 재처리는 멱등으로 처리하거나 마지막으로 처리한 이벤트 순번을 기억하여 무시하는 방법이 있음

#### 10.6.1 이벤트 처리와 DB 트랜잭션 고려
- 트랜잭션이 성공시에만 이벤트를 전달하게끔 구현
- 스프링은 @TransactionalEventListener 애너테이션을 제공

---
